diff -Nuar PackageKit-0.4.9-orig/backends/pisi/pisiBackend.py PackageKit-0.4.9/backends/pisi/pisiBackend.py
--- PackageKit-0.4.9-orig/backends/pisi/pisiBackend.py	2009-08-13 13:58:30.408652741 +0300
+++ PackageKit-0.4.9/backends/pisi/pisiBackend.py	2009-08-13 13:58:54.194653320 +0300
@@ -25,81 +25,6 @@
 
 class PackageKitPisiBackend(PackageKitBaseBackend, PackagekitPackage):
 
-    # It's an ugly way to sync with PK Groups and PiSi Components
-    # Maybe we can provide these with our index?
-    groups = {
-            "applications" : GROUP_OTHER,
-            "applications.admin" : GROUP_ADMIN_TOOLS,
-            "applications.archive" : GROUP_OTHER,
-            "applications.crypto" : GROUP_SECURITY,
-            "applications.doc" : GROUP_PUBLISHING,
-            "applications.doc.docbook" : GROUP_PUBLISHING,
-            "applications.editors" : GROUP_ACCESSORIES,
-            "applications.editors.emacs" : GROUP_ACCESSORIES,
-            "applications.emulators" : GROUP_OTHER,
-            "applications.filesystems" : GROUP_OTHER,
-            "applications.games" : GROUP_GAMES,
-            "applications.hardware" : GROUP_OTHER,
-            "applications.multimedia" : GROUP_MULTIMEDIA,
-            "applications.network" : GROUP_INTERNET,
-            "applications.network.mozilla" : GROUP_INTERNET,
-            "applications.pda" : GROUP_ACCESSORIES,
-            "applications.powermanagement" : GROUP_POWER_MANAGEMENT,
-            "applications.printing" : GROUP_PUBLISHING,
-            "applications.science" : GROUP_EDUCATION,
-            "applications.science.astronomy" : GROUP_EDUCATION,
-            "applications.science.electronics" : GROUP_EDUCATION,
-            "applications.science.mathematics" : GROUP_EDUCATION,
-            "applications.security" : GROUP_SECURITY,
-            "applications.shells" : GROUP_OTHER,
-            "applications.tex" : GROUP_PUBLISHING,
-            "applications.util" : GROUP_ACCESSORIES,
-            "applications.virtualization" : GROUP_VIRTUALIZATION,
-            "desktop.fonts" : GROUP_FONTS,
-            "desktop.freedesktop" : GROUP_DESKTOP_OTHER,
-            "desktop.freedesktop.inputmethods" : GROUP_LOCALIZATION,
-            "desktop.freedesktop.xorg" : GROUP_DESKTOP_OTHER,
-            "desktop.freedesktop.xorg.lib" : GROUP_DESKTOP_OTHER,
-            "desktop.gnome" : GROUP_DESKTOP_GNOME,
-            "desktop.kde" : GROUP_DESKTOP_KDE,
-            "desktop.kde.base" : GROUP_DESKTOP_KDE,
-            "desktop.kde.i18n" : GROUP_LOCALIZATION,
-            "kernel" : GROUP_SYSTEM,
-            "kernel.drivers" : GROUP_SYSTEM,
-            "kernel.firmware" : GROUP_SYSTEM,
-            "kernel-xen" : GROUP_VIRTUALIZATION,
-            "kernel-xen.dom0" : GROUP_VIRTUALIZATION,
-            "kernel-xen.dom0.drivers" : GROUP_VIRTUALIZATION,
-            "kernel-xen.dom0.firmware" : GROUP_VIRTUALIZATION,
-            "kernel-xen.domU" : GROUP_VIRTUALIZATION,
-            "programming" : GROUP_PROGRAMMING,
-            "programming.environments" : GROUP_PROGRAMMING,
-            "programming.environments.eclipse" : GROUP_PROGRAMMING,
-            "programming.languages" : GROUP_PROGRAMMING,
-            "programming.languages.dotnet" : GROUP_PROGRAMMING,
-            "programming.languages.gambas" : GROUP_PROGRAMMING,
-            "programming.languages.haskell" : GROUP_PROGRAMMING,
-            "programming.languages.java" : GROUP_PROGRAMMING,
-            "programming.languages.lisp" : GROUP_PROGRAMMING,
-            "programming.languages.pascal" : GROUP_PROGRAMMING,
-            "programming.languages.perl" : GROUP_PROGRAMMING,
-            "programming.languages.php" : GROUP_PROGRAMMING,
-            "programming.languages.python" : GROUP_PROGRAMMING,
-            "programming.languages.tcl" : GROUP_PROGRAMMING,
-            "programming.libs" : GROUP_PROGRAMMING,
-            "programming.tools" : GROUP_PROGRAMMING,
-            "server" : GROUP_SERVERS,
-            "server.database" : GROUP_SERVERS,
-            "server.mail" : GROUP_SERVERS,
-            "server.nis" : GROUP_SERVERS,
-            "server.www" : GROUP_SERVERS,
-            "system" : GROUP_SYSTEM,
-            "system.base" : GROUP_SYSTEM,
-            "system.devel" : GROUP_PROGRAMMING,
-            "system.doc" : GROUP_SYSTEM,
-            "system.locale" : GROUP_LOCALIZATION
-        }
-
     def __init__(self, args):
         PackageKitBaseBackend.__init__(self, args)
 
@@ -108,11 +33,19 @@
         self.installdb = pisi.db.installdb.InstallDB()
         self.packagedb = pisi.db.packagedb.PackageDB()
         self.repodb = pisi.db.repodb.RepoDB()
+        self.groupdb = pisi.db.groupdb.GroupDB()
 
         # Do not ask any question to users
         self.options = pisi.config.Options()
         self.options.yes_all = True
 
+    def __get_group(self, package):
+        try:
+            pkg_component = self.componentdb.get_component(package.partOf)
+            return pkg_component.group
+        except:
+            return "unknown"
+
     def __get_package_version(self, package):
         """ Returns version string of given package """
         # Internal FIXME: PiSi may provide this
@@ -173,17 +106,24 @@
         if self.packagedb.has_package(package):
             pkg = self.packagedb.get_package(package)
 
-            if self.groups.has_key(pkg.partOf):
-                group = self.groups[pkg.partOf]
+            if self.installdb.has_package(package):
+                pkg_status = "installed"
+            elif self.packagedb.has_package(package):
+                pkg_status = "available"
             else:
-                group = GROUP_UNKNOWN
+                pkg_status = "unknown"
 
-            self.details("%s-%s" % (pkg.name, self.__get_package_version(pkg)),
-                            pkg.license,
-                            group,
-                            pkg.description,
-                            pkg.packageURI,
-                            pkg.packageSize)
+            my_package_id = "%s;%s;%s;%s" % (pkg.name,
+                                            self.__get_package_version(pkg),
+                                            pkg.architecture,
+                                            pkg_status)
+
+            self.details(my_package_id,
+                         " ".join(pkg.license),
+                         self.__get_group(pkg),
+                         pkg.description,
+                         pkg.packageURI,
+                         pkg.packageSize)
         else:
             self.error(ERROR_PACKAGE_NOT_FOUND, "Package was not found")
 
@@ -197,10 +137,12 @@
         if self.installdb.has_package(package):
             pkg = self.installdb.get_files(package)
 
-            # FIXME: Add "/" as suffix
             files = map(lambda y: y.path, pkg.list)
 
-            file_list = ";".join(files)
+            # Reformat for PackageKit
+            # And add "/" for every file.
+            file_list = ";/".join(files)
+            file_list = "/%s" % file_list
 
             self.files(package, file_list)
 
@@ -209,10 +151,11 @@
         self.allow_cancel(True)
         self.percentage(None)
 
-        for repo in pisi.api.list_repos():
-            # Internal FIXME: What an ugly way to get repo uri
-            # FIXME: Use repository enabled/disabled state
-            self.repo_detail(repo, self.repodb.get_repo(repo).indexuri.get_uri(), "true")
+        for repo in pisi.api.list_repos(False):
+            if self.repodb.repo_active(repo):
+                self.repo_detail(repo, self.repodb.get_repo_url(repo), "true")
+            else:
+                self.repo_detail(repo, self.repodb.get_repo_url(repo), "false")
 
     def get_requires(self, filters, package_ids, recursive):
         """ Prints a list of requires for a given package """
@@ -253,7 +196,7 @@
 
         try:
             self.status(STATUS_INSTALL)
-            pisi.api.install([file])
+            pisi.api.install(files)
         except pisi.Error,e:
             # FIXME: Error: internal-error : Package re-install declined
             # Force needed?
@@ -309,6 +252,20 @@
         else:
             self.error(ERROR_PACKAGE_NOT_INSTALLED, "Package is not installed")
 
+
+    def repo_enable(self, repoid, enable):
+        '''
+        Implement the {backend}-repo-enable functionality
+        '''
+        try:
+            if enable == 'false':
+                pisi.api.set_repo_activity(repoid, False)
+            else:
+                pisi.api.set_repo_activity(repoid, True)
+        except Exception, e:
+            self.error(ERROR_INTERNAL_ERROR, _format_str(traceback.format_exc()))
+
+
     def repo_set_data(self, repo_id, parameter, value):
         """ Sets a parameter for the repository specified """
         self.allow_cancel(False)
@@ -369,10 +326,9 @@
         self.status(STATUS_INFO)
 
         try:
-            for key in self.groups.keys():
-                if self.groups[key] == group:
-                    for pkg in self.componentdb.get_packages(key, walk = True):
-                        self.__get_package(pkg, filters)
+            for key in self.groupdb.get_group_components(group):
+                for pkg in self.componentdb.get_packages(key, walk = True):
+                    self.__get_package(pkg, filters)
         except:
             self.error(ERROR_GROUP_NOT_FOUND, "Component %s was not found" % group)
 
diff -Nuar PackageKit-0.4.9-orig/backends/pisi/pk-backend-pisi.c PackageKit-0.4.9/backends/pisi/pk-backend-pisi.c
--- PackageKit-0.4.9-orig/backends/pisi/pk-backend-pisi.c	2009-08-13 13:58:30.408652741 +0300
+++ PackageKit-0.4.9/backends/pisi/pk-backend-pisi.c	2009-08-13 13:59:00.774652286 +0300
@@ -55,28 +55,40 @@
 static PkBitfield
 backend_get_groups (PkBackend *backend)
 {
-	return pk_bitfield_from_enums (
-		PK_GROUP_ENUM_ACCESSORIES,
-		PK_GROUP_ENUM_EDUCATION,
-		PK_GROUP_ENUM_GAMES,
-		PK_GROUP_ENUM_INTERNET,
-		PK_GROUP_ENUM_OTHER,
-		PK_GROUP_ENUM_PROGRAMMING,
-		PK_GROUP_ENUM_MULTIMEDIA,
-		PK_GROUP_ENUM_SYSTEM,
-		PK_GROUP_ENUM_DESKTOP_GNOME,
-		PK_GROUP_ENUM_DESKTOP_KDE,
-		PK_GROUP_ENUM_DESKTOP_OTHER,
-		PK_GROUP_ENUM_PUBLISHING,
-		PK_GROUP_ENUM_SERVERS,
-		PK_GROUP_ENUM_FONTS,
-		PK_GROUP_ENUM_ADMIN_TOOLS,
-		PK_GROUP_ENUM_LOCALIZATION,
-		PK_GROUP_ENUM_VIRTUALIZATION,
-		PK_GROUP_ENUM_SECURITY,
-		PK_GROUP_ENUM_POWER_MANAGEMENT,
-		PK_GROUP_ENUM_UNKNOWN,
-		-1);
+	int groups;
+	groups = pk_bitfield_from_enums(
+		   PK_GROUP_ENUM_ACCESSIBILITY,
+		   PK_GROUP_ENUM_ACCESSORIES,
+		   PK_GROUP_ENUM_ADMIN_TOOLS,
+		   PK_GROUP_ENUM_COMMUNICATION,
+		   PK_GROUP_ENUM_DESKTOP_GNOME,
+		   PK_GROUP_ENUM_DESKTOP_KDE,
+		   PK_GROUP_ENUM_DESKTOP_OTHER,
+		   PK_GROUP_ENUM_DESKTOP_XFCE,
+		   PK_GROUP_ENUM_EDUCATION,
+		   PK_GROUP_ENUM_FONTS,
+		   PK_GROUP_ENUM_GAMES,
+		   PK_GROUP_ENUM_GRAPHICS,
+		   PK_GROUP_ENUM_INTERNET,
+		   PK_GROUP_ENUM_LEGACY,
+		   PK_GROUP_ENUM_LOCALIZATION,
+		   PK_GROUP_ENUM_MULTIMEDIA,
+		   PK_GROUP_ENUM_NETWORK,
+		   PK_GROUP_ENUM_OFFICE,
+		   PK_GROUP_ENUM_OTHER,
+		   PK_GROUP_ENUM_POWER_MANAGEMENT,
+		   PK_GROUP_ENUM_PROGRAMMING,
+		   PK_GROUP_ENUM_PUBLISHING,
+		   PK_GROUP_ENUM_SECURITY,
+		   PK_GROUP_ENUM_SERVERS,
+		   PK_GROUP_ENUM_SYSTEM,
+		   PK_GROUP_ENUM_VIRTUALIZATION,
+		   PK_GROUP_ENUM_SCIENCE,
+		   PK_GROUP_ENUM_DOCUMENTATION,
+		   PK_GROUP_ENUM_ELECTRONICS,
+		   PK_GROUP_ENUM_UNKNOWN,
+		   -1);
+	return groups;
 }
 
 /**
@@ -92,6 +104,15 @@
 }
 
 /**
+ * backend_get_mime_types:
+ */
+static gchar *
+backend_get_mime_types (PkBackend *backend)
+{
+	return g_strdup ("application/x-pisi");
+}
+
+/**
  * pk_backend_cancel:
  */
 static void
@@ -231,6 +252,18 @@
 	pk_backend_spawn_helper (spawn, "pisiBackend.py", "remove-packages", pk_backend_bool_to_text (allow_deps), package_ids_temp, NULL);
 	g_free (package_ids_temp);
 }
+/**
+ * pk_backend_repo_enable:
+ */
+static void
+backend_repo_enable (PkBackend *backend, const gchar *rid, gboolean enabled)
+{
+	if (enabled == TRUE) {
+		pk_backend_spawn_helper (spawn, "pisiBackend.py", "repo-enable", rid, "true", NULL);
+	} else {
+		pk_backend_spawn_helper (spawn, "pisiBackend.py", "repo-enable", rid, "false", NULL);
+	}
+}
 
 /**
  * pk_backend_search_details:
@@ -353,7 +386,7 @@
 	backend_destroy,			/* destroy */
 	backend_get_groups,			/* get_groups */
 	backend_get_filters,			/* get_filters */
-	NULL,					/* get_mime_types */
+	backend_get_mime_types,			/* get_mime_types */
 	backend_cancel,				/* cancel */
 	NULL,					/* download_packages */
 	NULL,					/* get_categories */
@@ -371,7 +404,7 @@
 	NULL,					/* install_signature */
 	backend_refresh_cache,			/* refresh_cache */
 	backend_remove_packages,		/* remove_packages */
-	NULL,					/* repo_enable */
+	backend_repo_enable,			/* repo_enable */
 	backend_repo_set_data,			/* repo_set_data */
 	backend_resolve,			/* resolve */
 	NULL,					/* rollback */
