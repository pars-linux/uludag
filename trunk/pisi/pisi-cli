#!/usr/bin/python
#
# Copyright (C) 2005, TUBITAK/UEKAE
#
# This program is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free
# Software Foundation; either version 2 of the License, or (at your option)
# any later version.
#
# Please read the COPYING file.
#

import sys
import gettext

__trans = gettext.translation('pisi', fallback=True)
_ = __trans.ugettext

from pisi.cli.pisicli import PisiCLI

def handle_exception(exception, value, tb):
    import traceback
    import exceptions

    import pisi.ui
    import pisi.context as ctx
    from pisi.xmlext import XmlError

    ui = pisi.cli.CLI()
    show_traceback = False
    if exception == exceptions.KeyboardInterrupt:
        ui.error(_("\nKeyboardInterrupt: Exiting...\n"))
        sys.exit(1)
    elif exception == XmlError:
        ui.error(unicode(value))
        sys.exit(1)
    elif isinstance(value, pisi.Error):
        ui.error(_("Fatal Error"))
        show_traceback = ctx.config.get_option('debug')
    elif isinstance(value, pisi.Exception):
        show_traceback = True
        ui.error(_("""
Internal PISI Error:
Please file a bug report! (http://bugs.uludag.org.tr)
"""))
    else:
        # For any other exception (possibly Python exceptions) show
        # the traceback!
        show_traceback = ctx.config.get_option('debug')
        ui.error("System Error. Use --debug to see a traceback.")

    ui.error("%s: %s\n" % (exception, value))

    if show_traceback:
        ui.info(_("Traceback:"))
        traceback.print_tb(tb)

    sys.exit(1)

if __name__ == "__main__":
   
    sys.excepthook = handle_exception

    cli = PisiCLI()
    cli.run_command()
