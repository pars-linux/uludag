<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>dbus-qt3-backport: Providing services over DBus</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.4 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    <li><a href="examples.html"><span>Examples</span></a></li>
  </ul>
</div>
<h1><a class="anchor" name="dbusservice">Providing services over DBus </a></h1>Contents:<ul>
<li><a class="el" href="dbusservice.html#dbusservice-introduction">Introduction</a></li><li><a class="el" href="dbusservice.html#dbusservice-example">A simple DBus client example</a></li><li><a class="el" href="dbusservice.html#dbusservice-requestname">Requesting service name</a></li><li><a class="el" href="dbusservice.html#dbusservice-registerobjects">Registering objects</a></li><li><a class="el" href="dbusservice.html#dbusservice-interfaces">Service interfaces</a></li></ul>
<h2><a class="anchor" name="dbusservice-introduction">
Introduction</a></h2>
The Qt3 bindings do not support autogeneration of service objects yet. In order to provide interfaces over DBus, an application has to implement the <a class="el" href="classQDBusObjectBase.html" title="Base interface for DBus service objects.">QDBusObjectBase</a> interface and register an instance of the resulting class with the <a class="el" href="classQDBusConnection.html" title="Provides access to a specific DBus bus.">QDBusConnection</a>.<h2><a class="anchor" name="dbusservice-example">
A simple DBus client example</a></h2>
<div class="fragment"><pre class="fragment"><span class="preprocessor">   #include &lt;<a class="code" href="qdbusconnection_8h.html">dbus/qdbusconnection.h</a>&gt;</span>;
<span class="preprocessor">   #include &lt;<a class="code" href="qdbusobject_8h.html">dbus/qdbusobject.h</a>&gt;</span>;

   <span class="keyword">class </span>QStringList;

   <span class="keyword">class </span>TestService : <span class="keyword">public</span> <a class="code" href="classQDBusObjectBase.html" title="Base interface for DBus service objects.">QDBusObjectBase</a>
   {
   <span class="keyword">public</span>:
       TestService(<span class="keyword">const</span> <a class="code" href="classQDBusConnection.html" title="Provides access to a specific DBus bus.">QDBusConnection</a>&amp; connection);
       <span class="keyword">virtual</span> ~TestService();

   <span class="keyword">protected</span>:
       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> handleMethodCall(<span class="keyword">const</span> <a class="code" href="classQDBusMessage.html" title="A message converts and transports data over DBus.">QDBusMessage</a>&amp; message);

   <span class="keyword">private</span>:
       <a class="code" href="classQDBusConnection.html" title="Provides access to a specific DBus bus.">QDBusConnection</a> m_connection;

   <span class="keyword">private</span>:
       QStringList sortStrings(<span class="keyword">const</span> QStringList&amp; list);
   };
</pre></div> <div class="fragment"><pre class="fragment"><span class="preprocessor">   #include &lt;qstringlist.h&gt;</span>;

<span class="preprocessor">   #include &lt;<a class="code" href="qdbuserror_8h.html">dbus/qdbuserror.h</a>&gt;</span>;
<span class="preprocessor">   #include &lt;<a class="code" href="qdbusmessage_8h.html">dbus/qdbusmessage.h</a>&gt;</span>;

   TestService::TestService(<span class="keyword">const</span> <a class="code" href="classQDBusConnection.html" title="Provides access to a specific DBus bus.">QDBusConnection</a>&amp; connection) : m_connection(connection)
   {
       m_connection.registerObject(<span class="stringliteral">"/ListSorter"</span>, <span class="keyword">this</span>);
   }

   TestService::~TestService()
   {
       m_connection.unregisterObject(<span class="stringliteral">"/ListSorter"</span>);
   }

   <span class="comment">// return false to let D-BUS send a standard error message that the method is unknown</span>

   <span class="keywordtype">bool</span> TestService::handleMethod(<span class="keyword">const</span> <a class="code" href="classQDBusMessage.html" title="A message converts and transports data over DBus.">QDBusMessage</a>&amp; message)
   {
       <span class="keywordflow">if</span> (message.<a class="code" href="classQDBusMessage.html#f58a52f63ef03a9a7f974ba8bc5d786e" title="Returns the message&amp;#39;s interface name.">interface</a>() != <span class="stringliteral">"org.example.Sort"</span>) <span class="keywordflow">return</span> <span class="keyword">false</span>;

       <span class="keywordflow">if</span> (message.<a class="code" href="classQDBusMessage.html#9380a2b0317c7ea483f2a1ca51811599" title="Returns the message&amp;#39;s member name.">member</a>() == <span class="stringliteral">"Strings"</span>)
       {
           <span class="comment">// check parameters</span>

           <span class="keywordflow">if</span> (message.count() != 1 || message[0].<a class="code" href="classQDBusMessage.html#f82b589a030579b9f1aa3a8822641419" title="Returns which kind of message this is.">type</a>() != QVariant::StringList)
           {
               <span class="comment">// method signature not what we expected</span>

               <a class="code" href="classQDBusError.html" title="Class for transporting DBus errors.">QDBusError</a> error(<span class="stringliteral">"org.freedesktop.DBus.Error.InvalidSignature"</span>,
                                <span class="stringliteral">"Expected one argument of type string list"</span>);

               <a class="code" href="classQDBusMessage.html" title="A message converts and transports data over DBus.">QDBusMessage</a> reply = <a class="code" href="classQDBusMessage.html#98ec4597569748b047acb48ad3ef3a79" title="Creates a message for replying to a DBus method call.">QDBusMessage::methodError</a>(message, error);

               <span class="comment">// send error</span>

               m_connection.send(reply);

               <span class="comment">// tell D-BUS we did handle the call</span>

               <span class="keywordflow">return</span> <span class="keyword">true</span>;
           }

           <span class="comment">// call implementation</span>

           QStringList result = sortStrings(message[0].toStringList());

           <span class="comment">// prepare reply</span>

           <a class="code" href="classQDBusMessage.html" title="A message converts and transports data over DBus.">QDBusMessage</a> reply = <a class="code" href="classQDBusMessage.html#42cac722821a26c99e7acc79ef746c12" title="Creates a message for replying to a DBus method call.">QDBusMessage::methodReply</a>(message);

           reply &lt;&lt; result;

           <span class="comment">// send reply</span>

           m_connection.send(reply);

           <span class="comment">// tell D-BUS we did handle the call</span>

           <span class="keywordflow">return</span> <span class="keyword">true</span>;
       }

       <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }

   QStringList TestService::sortStrings(<span class="keyword">const</span> QStringList&amp; list)
   {
       QStringList result = list;

       result.sort();

       <span class="keywordflow">return</span> result;
   }
</pre></div> <div class="fragment"><pre class="fragment">   <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)
   {
       QApplication app(argc, argv, <span class="keyword">false</span>);

       <a class="code" href="classQDBusConnection.html" title="Provides access to a specific DBus bus.">QDBusConnection</a> connection = <a class="code" href="classQDBusConnection.html#293af4d19e3eb1950cdd3f954a1ae200" title="Add a connection to a bus with a specific bus type.">QDBusConnection::addConnection</a>(<a class="code" href="classQDBusConnection.html#44a8f0309154c8a61286a27eb224e8e1f4816dbeb082e50baa7e6d16b5b48b4d">QDBusConnection::SessionBus</a>);
       <span class="keywordflow">if</span> (!connection.<a class="code" href="classQDBusConnection.html#f6ab163c6e5d0ded0787a55b098bce62" title="Returns whether the connection is connected to a bus.">isConnected</a>())
           qFatal(<span class="stringliteral">"Cannot connect to session bus"</span>);

       <span class="comment">// try to get a specific service name</span>
       <span class="keywordflow">if</span> (!connection.<a class="code" href="classQDBusConnection.html#23dda3edeed41c1de5cb334605985ebd" title="Requests to be addressable on the bus by a given name.">requestName</a>(<span class="stringliteral">"org.example.SortService"</span>))
       {
           qWarning(<span class="stringliteral">"Requesting name 'org.example.SortService' failed. "</span>
                    <span class="stringliteral">"Will only be addressable through unique name '%s'"</span>,
                    connection.<a class="code" href="classQDBusConnection.html#c50de3e1018ae43b862b1e5af73532bb" title="Returns the connection identifier assigned at connect.">uniqueName</a>().local8Bit().data());
       }
       <span class="keywordflow">else</span>
       {
           qDebug(<span class="stringliteral">"Requesting name 'org.example.SortService' successfull"</span>);
       }

       TestService service(connection);

       <span class="keywordflow">return</span> app.exec();
    }
</pre></div><h2><a class="anchor" name="dbusservice-requestname">
Requesting service name</a></h2>
When an application connects to DBus it gets a unique name generated by the bus daemon.<p>
However, an application providing service will often want to be reachable under a fixed name, like a webserver being reachable through a domain name independent from its actual IP address. See section <a class="el" href="dbusconventions.html#dbusconventions-servicename">Service names</a> for details on service names.<p>
In order to get such a specific name an application has to request it using <a class="el" href="classQDBusConnection.html#23dda3edeed41c1de5cb334605985ebd" title="Requests to be addressable on the bus by a given name.">QDBusConnection::requestName()</a><p>
The example above request <code>"org.example.SortService"</code> but continues with the default unique name in the case some other application is currently owning that name.<h2><a class="anchor" name="dbusservice-registerobjects">
Registering objects</a></h2>
To make service objects available to other applications on the same bus the application has to register the objects instances with the connection to the bus using <a class="el" href="classQDBusConnection.html#ead34bb23daf5a09c5507e914376fab8" title="Registers a service object for a given path.">QDBusConnection::registerObject()</a><p>
Registering means to specify an object path where the object will be located, i.e. how it can be unambiguously be addressed in method calls. See section <a class="el" href="dbusconventions.html#dbusconventions-objectpath">Object paths</a> for details on object paths.<p>
If the applications has introspectable objects it is recommended to register an introspectable root object, i.e. using <code>"/"</code> as the path, so other applications have a common place to start asking for introspection data.<p>
In the example above a service object providing sorting services on lists is registered on the path <code>"/ListSorter"</code> <h2><a class="anchor" name="dbusservice-interfaces">
Service interfaces</a></h2>
DBus methods and signals of a service object a grouped into interfaces.<p>
See section <a class="el" href="dbusconventions.html#dbusconventions-interfacename">Interface names</a> for details on interface naming.<p>
An object can implement any number of interfaces, for example the interface for the functionality it wants to provide and a DBus standard interface like <code>"org.freedesktop.DBus.Introspectable"</code> for providing an XML description of all its interfaces.<p>
The service object of the example above implements just one interface <code>"org.example.Sort"</code> and its handleMethodCall() explicitly checks all received messages and rejects any messsage not sent to this particular interface by returning <code>false</code> and thus telling the DBus layer to generate a standard error response.<p>
Multiple interfaces can of course be directly implemented in one C++ class, however it might sometimes be wise to delegate calls for different interfaces to different implementations: <div class="fragment"><pre class="fragment">   <span class="keyword">class </span>Interface1 : <span class="keyword">public</span> <a class="code" href="classQDBusObjectBase.html" title="Base interface for DBus service objects.">QDBusObjectBase</a>
   {
   <span class="keyword">public</span>:
       Interface1(<span class="keyword">const</span> <a class="code" href="classQDBusConnection.html" title="Provides access to a specific DBus bus.">QDBusConnection</a>&amp;);

   <span class="keyword">protected</span>:
       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> handleMethodCall(<span class="keyword">const</span> <a class="code" href="classQDBusMessage.html" title="A message converts and transports data over DBus.">QDBusMessage</a>&amp;);
   };

   <span class="keyword">class </span>Interface2 : <span class="keyword">public</span> <a class="code" href="classQDBusObjectBase.html" title="Base interface for DBus service objects.">QDBusObjectBase</a>
   {
   <span class="keyword">public</span>:
       Interface2(<span class="keyword">const</span> <a class="code" href="classQDBusConnection.html" title="Provides access to a specific DBus bus.">QDBusConnection</a>&amp;);

   <span class="keyword">protected</span>:
       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> handleMethodCall(<span class="keyword">const</span> <a class="code" href="classQDBusMessage.html" title="A message converts and transports data over DBus.">QDBusMessage</a>&amp;);
   };

   <span class="keyword">class </span>MultiInterfaceService : <span class="keyword">public</span> <a class="code" href="classQDBusObjectBase.html" title="Base interface for DBus service objects.">QDBusObjectBase</a>
   {
   <span class="keyword">public</span>:
       MultiInterfaceService(<span class="keyword">const</span> <a class="code" href="classQDBusConnection.html" title="Provides access to a specific DBus bus.">QDBusConnection</a>&amp;);

   <span class="keyword">protected</span>:
       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> handleMethodCall(<span class="keyword">const</span> <a class="code" href="classQDBusMessage.html" title="A message converts and transports data over DBus.">QDBusMessage</a>&amp;);

   <span class="keyword">private</span>:
       QMap&lt;QString, QDBusObjectBase*&gt; m_interfaces;
   };

   MultiInterfaceService::MultiInterfaceService(<span class="keyword">const</span> <a class="code" href="classQDBusConnection.html" title="Provides access to a specific DBus bus.">QDBusConnection</a>&amp; connection)
   {
       m_interfaces.insert(<span class="stringliteral">"org.example.Interface1"</span>, <span class="keyword">new</span> Interface1(connection));
       m_interfaces.insert(<span class="stringliteral">"org.example.Interface2"</span>, <span class="keyword">new</span> Interface2(connection));
   }

   <span class="keywordtype">bool</span> <a class="code" href="classQDBusObjectBase.html#df2a2fdd56d63ef88dbf093e2701ba76" title="Method call entry point.">MultiInterfaceService::handleMethodCall</a>(<span class="keyword">const</span> <a class="code" href="classQDBusMessage.html" title="A message converts and transports data over DBus.">QDBusMessage</a>&amp; message)
   {
       <span class="comment">// delegate call to its interface handler</span>
       <a class="code" href="classQDBusObjectBase.html" title="Base interface for DBus service objects.">QDBusObjectBase</a>* handler = m_interfaces[message.<a class="code" href="classQDBusMessage.html#f58a52f63ef03a9a7f974ba8bc5d786e" title="Returns the message&amp;#39;s interface name.">interface</a>()];
       <span class="keywordflow">if</span> (handler != 0)
           <span class="keywordflow">return</span> handler-&gt;<a class="code" href="classQDBusObjectBase.html#df2a2fdd56d63ef88dbf093e2701ba76" title="Method call entry point.">handleMethodCall</a>(message);
       <span class="keywordflow">else</span>
           <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// no such interface</span>
   }
</pre></div> <hr size="1"><address style="text-align: right;"><small>Generated on Sat Jan 12 13:34:14 2008 for dbus-qt3-backport by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.4 </small></address>
</body>
</html>
